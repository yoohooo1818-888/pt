<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>å€’æ°´çº¢åŒ…ç‰ˆ - Playable Ad Demo</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; touch-action:manipulation; -webkit-tap-highlight-color:transparent; user-select:none; }
html, body { 
  width:100%; height:100%; overflow:hidden;
  background: radial-gradient(ellipse at center, #1a2b4a 0%, #0a1628 100%);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
}

/* é€‚é…iPhoneåˆ˜æµ·å± */
@supports (padding-top: env(safe-area-inset-top)) {
  body { padding-top: env(safe-area-inset-top); }
}

/* çº¢åŒ…æ ·å¼ - é¡¶éƒ¨ç›®æ ‡åŒºåŸŸ */
.red-packets-container { 
  position:absolute; top:60px; left:0; right:0; 
  display:flex; justify-content:center; gap:40px; z-index:10;
}
.red-packet { 
  position:relative; width:80px; height:100px; 
  transition:transform 0.3s; cursor:default;
}
.red-packet-inner {
  width:100%; height:100%; 
  background:url('çº¢åŒ….png') center/contain no-repeat;
  filter:drop-shadow(0 4px 12px rgba(0,0,0,0.4));
  transition:all 0.3s;
}
.red-packet.waiting .red-packet-inner { 
  animation:glow 2s ease-in-out infinite;
  filter:drop-shadow(0 0 15px rgba(255,215,0,0.6)) drop-shadow(0 4px 12px rgba(0,0,0,0.4));
}
@keyframes glow { 
  0%,100%{transform:scale(1);} 
  50%{transform:scale(1.05);} 
}
.red-packet.collecting .red-packet-inner {
  animation:shake 0.5s ease-in-out;
}
@keyframes shake { 
  0%,100%{transform:rotate(0);} 
  25%{transform:rotate(-15deg);} 
  75%{transform:rotate(15deg);} 
}
.red-packet.completed { opacity:0.6; }
.red-packet.completed .red-packet-inner { filter:grayscale(0.3) brightness(0.8); }

/* ç“¶å­åŒºåŸŸ - ä¸­éƒ¨äº¤äº’åŒº */
.bottles-container {
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  display:flex; gap:20px; align-items:flex-end; z-index:20;
}
.bottle-wrapper { 
  position:relative; width:80px; height:160px; cursor:pointer;
  transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.bottle-wrapper.selected { 
  transform:scale(1.15) translateY(-10px); 
  filter:drop-shadow(0 0 20px rgba(255,255,255,0.6));
  z-index:30;
}
.bottle-wrapper.pouring { 
  animation:tiltPour 1s ease-in-out forwards;
  z-index:30;
}
@keyframes tiltPour {
  0%{transform:rotate(0) translateY(0);}
  20%{transform:rotate(0) translateY(-30px);}
  60%{transform:rotate(-55deg) translateY(-30px) translateX(20px);}
  100%{transform:rotate(0) translateY(0);}
}

/* ç»ç’ƒä¸»ä½“ */
.bottle-body {
  position:absolute; bottom:0; width:100%; height:140px;
  background:url('ç»ç’ƒç“¶.png') center bottom/contain no-repeat;
  z-index:10; pointer-events:none;
}
/* æ¶²ä½“å®¹å™¨ - è£å‰ªåŒºåŸŸ */
.liquid-container {
  position:absolute; bottom:10px; left:15px; right:15px; height:110px;
  overflow:hidden; border-radius:0 0 20px 20px;
  display:flex; flex-direction:column-reverse; z-index:5;
}
.liquid-layer {
  width:100%; height:25%; 
  position:relative; transition:all 0.4s ease;
}
.liquid-layer::after { /* æ¶²ä½“è¡¨é¢å…‰æ³½ */
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(to right, transparent, rgba(255,255,255,0.4), transparent);
}
/* è½¯æœ¨å¡ */
.cork {
  position:absolute; top:-5px; left:50%; transform:translateX(-50%) translateY(-20px);
  width:50px; height:40px; opacity:0;
  background:url('è½¯æœ¨å¡.png') center/contain no-repeat;
  transition:all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  z-index:20; pointer-events:none;
}
.bottle-wrapper.corked .cork {
  opacity:1; transform:translateX(-50%) translateY(0);
}

/* æ°´æµæ•ˆæœ */
.water-stream {
  position:fixed; height:6px; border-radius:3px; opacity:0.9;
  background:linear-gradient(to right, rgba(255,255,255,0.9), currentColor 20%, currentColor);
  box-shadow:0 0 10px currentColor;
  pointer-events:none; z-index:25;
  transform-origin:left center;
}

/* ç²’å­ç‰¹æ•ˆ */
.particle-system {
  position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:100;
}
.particle {
  position:absolute; border-radius:50%; pointer-events:none;
  background:radial-gradient(circle at 30% 30%, #FFF, #FFD700, #FFA500);
  box-shadow:0 0 6px #FFD700;
}
.floating-text {
  position:absolute; font-weight:bold; font-size:24px; color:#FFD700;
  text-shadow:0 2px 4px rgba(0,0,0,0.5), 0 0 20px rgba(255,215,0,0.8);
  pointer-events:none; animation:floatUp 1.2s ease-out forwards;
}
@keyframes floatUp {
  0%{transform:translateY(0) scale(1); opacity:1;}
  100%{transform:translateY(-80px) scale(1.2); opacity:0;}
}

/* UIå±‚ */
.ui-layer { position:fixed; top:0; left:0; right:0; bottom:0; pointer-events:none; z-index:50; }
.hint-box {
  position:absolute; top:180px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,0.6); backdrop-filter:blur(10px);
  padding:12px 24px; border-radius:20px; border:1px solid rgba(255,255,255,0.2);
  color:#fff; font-size:16px; white-space:nowrap;
  transition:all 0.3s;
}
.hint-box.error { color:#FF6B6B; border-color:#FF6B6B; animation:shakeHint 0.4s; }
@keyframes shakeHint { 0%,100%{transform:translateX(-50%);} 25%{transform:translateX(-53%);} 75%{transform:translateX(-47%);} }

/* CTAæŒ‰é’® */
.cta-button {
  position:absolute; bottom:40px; left:50%; transform:translateX(-50%);
  background:linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%);
  color:white; font-size:20px; font-weight:bold; padding:18px 60px;
  border-radius:35px; border:none; cursor:pointer;
  box-shadow:0 6px 20px rgba(238,90,111,0.4), inset 0 -2px 0 rgba(0,0,0,0.1);
  pointer-events:auto; display:none;
  animation:ctaPulse 2s infinite;
  transition:transform 0.2s;
}
.cta-button:active { transform:translateX(-50%) scale(0.95); }
@keyframes ctaPulse { 0%,100%{transform:translateX(-50%) scale(1); box-shadow:0 6px 20px rgba(238,90,111,0.4);} 50%{transform:translateX(-50%) scale(1.05); box-shadow:0 8px 30px rgba(238,90,111,0.6);} }
.cta-button.show { display:block; animation:ctaIn 0.5s, ctaPulse 2s infinite; }
@keyframes ctaIn { from{transform:translateX(-50%) translateY(50px); opacity:0;} to{transform:translateX(-50%) translateY(0); opacity:1;} }

/* èƒœåˆ©å¼¹çª— */
.win-modal {
  position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.85); backdrop-filter:blur(5px);
  display:none; flex-direction:column; align-items:center; justify-content:center; z-index:200;
}
.win-modal.show { display:flex; animation:fadeIn 0.5s; }
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
.win-title { 
  font-size:48px; font-weight:bold; color:#FFD700; 
  text-shadow:0 4px 0 #B8860B, 0 0 40px rgba(255,215,0,0.5);
  margin-bottom:20px; animation:titlePop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes titlePop { from{transform:scale(0);} to{transform:scale(1);} }
.win-subtitle { color:#fff; font-size:18px; margin-bottom:40px; opacity:0.9; }
.firework-canvas { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }

/* å“åº”å¼é€‚é… */
@media (max-width:375px) {
  .bottles-container { gap:10px; transform:translate(-50%,-50%) scale(0.9); }
  .red-packets-container { gap:25px; }
}
</style>
</head>
<body>

<div class="red-packets-container" id="redPackets"></div>
<div class="bottles-container" id="bottles"></div>
<div class="particle-system" id="particles"></div>

<div class="ui-layer">
  <div class="hint-box" id="hint">ç‚¹å‡»ç“¶å­é€‰æ‹©ï¼Œå†ç‚¹å‡»å¦ä¸€ç“¶å­å€’æ°´</div>
  <button class="cta-button" id="cta" onclick="handleDownload()">ğŸ§§ é¢†çº¢åŒ…ä¸‹è½½APP</button>
</div>

<div class="win-modal" id="winModal">
  <canvas class="firework-canvas" id="fireworkCanvas"></canvas>
  <div class="win-title">ğŸ‰ æ­å–œé€šå…³</div>
  <div class="win-subtitle">æ‰€æœ‰çº¢åŒ…å·²é¢†å–ï¼</div>
  <button class="cta-button" style="display:block; position:relative; bottom:auto; transform:none; margin-top:20px;" onclick="handleDownload()">ç«‹å³ä¸‹è½½é¢†å–å¥–åŠ±</button>
</div>

<script>
// æ¸¸æˆé…ç½®
const COLORS = [
  { name:'red', hex:'#FF4757', label:'çº¢' },
  { name:'blue', hex:'#3742FA', label:'è“' },
  { name:'green', hex:'#2ED573', label:'ç»¿' }
];

// æ¸¸æˆçŠ¶æ€
let bottles = [];
let selectedIndex = null;
let isAnimating = false;
let completedCount = 0;

// åˆå§‹åŒ–
window.onload = () => {
  initRedPackets();
  initLevel();
};

// åˆ›å»ºçº¢åŒ…
function initRedPackets() {
  const container = document.getElementById('redPackets');
  COLORS.forEach((color, idx) => {
    const packet = document.createElement('div');
    packet.className = 'red-packet waiting';
    packet.id = `packet-${color.name}`;
    packet.innerHTML = '<div class="red-packet-inner"></div>';
    packet.dataset.color = color.name;
    container.appendChild(packet);
  });
}

// åˆå§‹åŒ–å…³å¡ï¼ˆç®€åŒ–ç‰ˆï¼Œç¡®ä¿å¯è§£ï¼‰
function initLevel() {
  const container = document.getElementById('bottles');
  const levelData = [
    [COLORS[0], COLORS[1], COLORS[1]], // çº¢è“è“
    [COLORS[2], COLORS[0], COLORS[2]], // ç»¿çº¢ç»¿
    [COLORS[1], COLORS[2], COLORS[0]], // è“ç»¿çº¢
    [] // ç©ºç“¶
  ];
  
  levelData.forEach((colors, idx) => {
    const bottle = createBottle(idx, colors);
    bottles.push(bottle);
    container.appendChild(bottle.element);
  });
}

// åˆ›å»ºç“¶å­
function createBottle(index, colors) {
  const wrapper = document.createElement('div');
  wrapper.className = 'bottle-wrapper';
  wrapper.dataset.index = index;
  wrapper.onclick = () => onBottleClick(index);
  
  const body = document.createElement('div');
  body.className = 'bottle-body';
  
  const liquidContainer = document.createElement('div');
  liquidContainer.className = 'liquid-container';
  liquidContainer.id = `liquid-${index}`;
  
  const cork = document.createElement('div');
  cork.className = 'cork';
  
  wrapper.appendChild(body);
  wrapper.appendChild(liquidContainer);
  wrapper.appendChild(cork);
  
  updateLiquid(index, colors);
  
  return { element: wrapper, colors: colors || [], index };
}

// æ›´æ–°æ¶²ä½“æ˜¾ç¤º
function updateLiquid(index, colors) {
  const container = document.getElementById(`liquid-${index}`);
  container.innerHTML = '';
  if (!colors) return;
  
  colors.forEach(color => {
    const layer = document.createElement('div');
    layer.className = 'liquid-layer';
    layer.style.backgroundColor = color.hex;
    layer.style.boxShadow = `inset 0 0 10px rgba(255,255,255,0.2), 0 0 5px ${color.hex}40`;
    container.appendChild(layer);
  });
  
  // æ£€æŸ¥æ˜¯å¦éœ€è¦è½¯æœ¨å¡
  const bottle = bottles[index];
  if (colors.length === 4 && isUniformColor(colors)) {
    bottle.element.classList.add('corked');
  } else {
    bottle.element.classList.remove('corked');
  }
}

// æ£€æŸ¥æ˜¯å¦åŒè‰²
function isUniformColor(colors) {
  if (colors.length === 0) return false;
  return colors.every(c => c.name === colors[0].name);
}

// ç‚¹å‡»å¤„ç†
function onBottleClick(index) {
  if (isAnimating) return;
  
  const bottle = bottles[index];
  
  // å¦‚æœå·²é€‰ä¸­ï¼Œå–æ¶ˆé€‰æ‹©
  if (selectedIndex === index) {
    bottle.element.classList.remove('selected');
    selectedIndex = null;
    showHint('ç‚¹å‡»ç“¶å­é€‰æ‹©ï¼Œå†ç‚¹å‡»å¦ä¸€ç“¶å­å€’æ°´');
    return;
  }
  
  // å¦‚æœå·²é€‰ä¸­å…¶ä»–ï¼Œå°è¯•å€’æ°´
  if (selectedIndex !== null) {
    attemptPour(selectedIndex, index);
    return;
  }
  
  // é€‰æ‹©ç“¶å­ï¼ˆç©ºç“¶ä¸èƒ½é€‰ï¼‰
  if (bottle.colors.length === 0) {
    showHint('ç©ºç“¶å­ä¸èƒ½é€‰æ‹©', true);
    return;
  }
  
  bottle.element.classList.add('selected');
  selectedIndex = index;
  showHint('å†ç‚¹å‡»ç›®æ ‡ç“¶å­å€’æ°´');
}

// å°è¯•å€’æ°´
function attemptPour(fromIdx, toIdx) {
  const from = bottles[fromIdx];
  const to = bottles[toIdx];
  
  // éªŒè¯è§„åˆ™
  const fromColor = from.colors[from.colors.length - 1];
  const toColor = to.colors[to.colors.length - 1];
  
  if (to.colors.length >= 4) {
    showHint('ç›®æ ‡ç“¶å­å·²æ»¡', true);
    return;
  }
  if (toColor && toColor.name !== fromColor.name) {
    showHint('åªèƒ½å€’å…¥ç›¸åŒé¢œè‰²çš„æ¶²ä½“', true);
    return;
  }
  
  // æ‰§è¡Œå€’æ°´
  isAnimating = true;
  from.element.classList.remove('selected');
  selectedIndex = null;
  
  // åŠ¨ç”»å¼€å§‹
  from.element.classList.add('pouring');
  createWaterStream(from.element, to.element, fromColor.hex);
  
  setTimeout(() => {
    // æ•°æ®æ›´æ–°
    to.colors.push(fromColor);
    from.colors.pop();
    
    // è§†è§‰æ›´æ–°
    updateLiquid(fromIdx, from.colors);
    updateLiquid(toIdx, to.colors);
    
    from.element.classList.remove('pouring');
    
    // æ£€æŸ¥æ˜¯å¦æ»¡ç“¶å¯æ”¶é›†
    if (to.colors.length === 4 && isUniformColor(to.colors)) {
      setTimeout(() => collectBottle(toIdx), 300);
    } else {
      isAnimating = false;
      checkWin();
    }
    
    showHint('ç‚¹å‡»ç“¶å­é€‰æ‹©ï¼Œå†ç‚¹å‡»å¦ä¸€ç“¶å­å€’æ°´');
  }, 1000);
}

// åˆ›å»ºæ°´æµ
function createWaterStream(fromEl, toEl, color) {
  const stream = document.createElement('div');
  stream.className = 'water-stream';
  stream.style.color = color;
  stream.style.background = `linear-gradient(to right, rgba(255,255,255,0.8), ${color})`;
  
  const rect1 = fromEl.getBoundingClientRect();
  const rect2 = toEl.getBoundingClientRect();
  
  const x1 = rect1.left + rect1.width/2;
  const y1 = rect1.top + 20;
  const x2 = rect2.left + rect2.width/2;
  const y2 = rect2.top + 20;
  
  const length = Math.hypot(x2-x1, y2-y1);
  const angle = Math.atan2(y2-y1, x2-x1) * 180 / Math.PI;
  
  stream.style.left = x1 + 'px';
  stream.style.top = y1 + 'px';
  stream.style.width = length + 'px';
  stream.style.transform = `rotate(${angle}deg)`;
  
  document.body.appendChild(stream);
  
  setTimeout(() => {
    stream.style.opacity = '0';
    setTimeout(() => stream.remove(), 200);
  }, 800);
}

// æ”¶é›†ç“¶å­åˆ°çº¢åŒ…
function collectBottle(index) {
  const bottle = bottles[index];
  const colorName = bottle.colors[0].name;
  const packet = document.getElementById(`packet-${colorName}`);
  const packetRect = packet.getBoundingClientRect();
  const bottleRect = bottle.element.getBoundingClientRect();
  
  // æ”¶é›†åŠ¨ç”»
  packet.classList.add('collecting');
  bottle.element.style.transition = 'all 0.8s cubic-bezier(0.68,-0.55,0.265,1.55)';
  bottle.element.style.transform = `translate(${packetRect.left - bottleRect.left + 20}px, ${packetRect.top - bottleRect.top + 20}px) scale(0.2) rotate(720deg)`;
  bottle.element.style.opacity = '0';
  
  // é‡‘å¸ç‰¹æ•ˆ
  setTimeout(() => {
    createParticles(packetRect.left + 40, packetRect.top + 50);
    createFloatingText(packetRect.left + 20, packetRect.top - 20, '+100é‡‘å¸');
    packet.classList.remove('collecting');
    packet.classList.add('completed');
    completedCount++;
    
    setTimeout(() => {
      bottle.element.style.display = 'none';
      isAnimating = false;
      checkWin();
    }, 300);
  }, 600);
}

// ç²’å­ç‰¹æ•ˆ
function createParticles(x, y) {
  const container = document.getElementById('particles');
  for (let i = 0; i < 40; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const size = 4 + Math.random() * 8;
    p.style.width = size + 'px';
    p.style.height = size + 'px';
    p.style.left = (x + Math.random() * 60 - 30) + 'px';
    p.style.top = (y + Math.random() * 60 - 30) + 'px';
    
    const angle = Math.random() * Math.PI * 2;
    const velocity = 100 + Math.random() * 150;
    const tx = Math.cos(angle) * velocity;
    const ty = Math.sin(angle) * velocity - 50;
    
    p.animate([
      { transform: 'translate(0,0) scale(1)', opacity: 1 },
      { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
    ], {
      duration: 1000 + Math.random() * 500,
      easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
      fill: 'forwards'
    }).onfinish = () => p.remove();
    
    container.appendChild(p);
  }
}

// é£˜å­—
function createFloatingText(x, y, text) {
  const el = document.createElement('div');
  el.className = 'floating-text';
  el.textContent = text;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  document.getElementById('particles').appendChild(el);
  setTimeout(() => el.remove(), 1200);
}

// æç¤ºæ–‡å­—
function showHint(text, isError = false) {
  const hint = document.getElementById('hint');
  hint.textContent = text;
  hint.className = isError ? 'hint-box error' : 'hint-box';
  if (isError) setTimeout(() => showHint('ç‚¹å‡»ç“¶å­é€‰æ‹©ï¼Œå†ç‚¹å‡»å¦ä¸€ç“¶å­å€’æ°´'), 1500);
}

// æ£€æŸ¥èƒœåˆ©
function checkWin() {
  if (completedCount >= 3) {
    setTimeout(() => {
      document.getElementById('winModal').classList.add('show');
      startFireworks();
      document.getElementById('cta').classList.add('show');
    }, 500);
  }
}

// çƒŸèŠ±æ•ˆæœï¼ˆCanvasï¼‰
function startFireworks() {
  const canvas = document.getElementById('fireworkCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  
  const fireworks = [];
  class Firework {
    constructor() {
      this.x = Math.random() * canvas.width;
      this.y = canvas.height;
      this.targetY = Math.random() * canvas.height * 0.5;
      this.color = `hsl(${Math.random()*60+30},100%,50%)`;
      this.speed = 8;
      this.exploded = false;
      this.particles = [];
    }
    update() {
      if (!this.exploded) {
        this.y -= this.speed;
        if (this.y <= this.targetY) {
          this.exploded = true;
          for (let i=0; i<30; i++) {
            this.particles.push({
              x:this.x, y:this.y,
              vx:Math.cos(i/30*Math.PI*2)*5,
              vy:Math.sin(i/30*Math.PI*2)*5,
              alpha:1
            });
          }
        }
      } else {
        this.particles.forEach(p => {
          p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.alpha -= 0.02;
        });
        this.particles = this.particles.filter(p => p.alpha > 0);
      }
    }
    draw() {
      if (!this.exploded) {
        ctx.beginPath();
        ctx.arc(this.x, this.y, 3, 0, Math.PI*2);
        ctx.fillStyle = this.color;
        ctx.fill();
      } else {
        this.particles.forEach(p => {
          ctx.beginPath();
          ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
          ctx.fillStyle = this.color;
          ctx.globalAlpha = p.alpha;
          ctx.fill();
          ctx.globalAlpha = 1;
        });
      }
    }
  }
  
  function loop() {
    ctx.fillStyle = 'rgba(0,0,0,0.1)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    if (Math.random() < 0.05) fireworks.push(new Firework());
    fireworks.forEach((f, i) => {
      f.update(); f.draw();
      if (f.exploded && f.particles.length === 0) fireworks.splice(i, 1);
    });
    
    requestAnimationFrame(loop);
  }
  loop();
}

// ä¸‹è½½å¤„ç†ï¼ˆå ä½ï¼‰
function handleDownload() {
  // è¿™é‡Œæ›¿æ¢ä¸ºå®é™…è·³è½¬é€»è¾‘
  console.log('CTA Clicked');
  // window.location.href = 'https://ä½ çš„ä¸‹è½½é“¾æ¥';
  alert('è¿™é‡Œè·³è½¬åˆ°åº”ç”¨å•†åº—ä¸‹è½½é¡µé¢');
}

// é˜»æ­¢é»˜è®¤æ»šåŠ¨
document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
</script>
</body>
</html>
